% =============================
% PREAMBLE — LuaLaTeX
% =============================

% Quiet a few harmless warnings (optional)
\usepackage{silence}
\WarningFilter{latex}{Command \showhyphens has changed}
\WarningFilter{latexfont}{Font shape}

% ---------- Language & fonts ----------
\usepackage[english]{babel}
\usepackage{fontspec}

% ---------- Math (order matters) ----------
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{mathtools}
\usepackage[mathrm=sym,warnings-off={mathtools-colon, mathtools-overbracket}]{unicode-math}

% Text fonts
\setmainfont{Fira Sans}
\setsansfont{IBM Plex Sans Condensed}
\setmonofont{Fira Code}
\setmathfont{Fira Math}
\setmathfont[range={\mathbb,\mathcal,\Re,\Im,\top,\bigcup,\cup,\vdots,\ddots,\star,\setminus}]{STIX Two Math}

% ---------- Typography & lists ----------
\usepackage[final]{microtype}
\usepackage{xcolor}
\usepackage{ragged2e}
\usepackage{enumitem}
\usepackage{suffix}

% ---------- TOC styling ----------
\usepackage{tocloft}
\renewcommand{\cfttoctitlefont}{\Large\bfseries}
\renewcommand{\cftsecfont}{\bfseries}
\renewcommand{\cftsubsecfont}{\small}
\setlength{\cftbeforesecskip}{3pt}
\setlength{\cftbeforesubsecskip}{1pt}

% ---------- Tables & figures ----------
\usepackage{booktabs}
\usepackage{tabularx}
\usepackage{array}
\usepackage{colortbl}
\usepackage{multirow}
\usepackage{siunitx}

\usepackage{float}
\usepackage{subcaption}
\usepackage[autostyle]{csquotes}

% ---------- Algorithms ----------
\usepackage{algorithm}
\usepackage[noend]{algpseudocode}

% ---------- Layout & links ----------
\input{tex/colors}
\usepackage[most]{tcolorbox}
\usepackage[headheight=15pt, margin=2.5cm, includeheadfoot]{geometry}
\usepackage{parskip}

\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\fancyhead[L]{\leftmark}
\fancyhead[R]{\thepage}
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0pt}

\usepackage[colorlinks, plainpages=false]{hyperref}
\usepackage{bookmark}

\hypersetup{
  colorlinks=true,
  linkcolor=thm-color,
  filecolor=magenta,
  urlcolor=cyan
}

% ---------- Localized theorem names ----------
\addto\captionsenglish{%
  \def\definitionname{Definition}%
  \def\theoremname{Theorem}%
  \def\lemmaname{Lemma}%
  \def\examplename{Example}%
  \def\remarkname{Remark}%
  \def\propositionname{Proposition}%
  \def\corollaryname{Corollary}%
  \def\solutionname{Solution}%
}
\addto\captionsnorwegian{%
  \def\definitionname{Definisjon}%
  \def\theoremname{Teorem}%
  \def\lemmaname{Lemma}%
  \def\examplename{Eksempel}%
  \def\remarkname{Bemerkning}%
  \def\propositionname{Proposisjon}%
  \def\corollaryname{Korollar}%
  \def\solutionname{Løsning}%
}

% ---------- Theorem environments (tcolorbox) ----------
\tcbset{
  base theorem style/.style={
      enhanced,
      fonttitle=\bfseries,
      breakable,
      before skip=10pt,
      after skip=10pt,
      separator sign=.,
      sharp corners
    },
}

\newtcbtheorem[number within=section]{definition}{\definitionname}{%
  enhanced jigsaw,
  colback=def-color!10,
  colframe=def-color!80!black,
  fonttitle=\bfseries,
  coltitle=black,
  attach boxed title to top left={xshift=10pt,yshift=-\tcboxedtitleheight/2},
  boxed title style={colback=def-color!10,colframe=def-color!80!black,height=16pt,valign=center,bean arc},
  separator sign=.,
  label separator={},
  top=8pt,bottom=2pt,left=4pt,right=4pt,boxrule=1pt
}{def}

\newtcbtheorem[use counter from=definition]{theorem}{\theoremname}{%
  enhanced jigsaw,
  colback=thm-color!10,
  colframe=thm-color!80!black,
  fonttitle=\bfseries,
  coltitle=black,
  attach boxed title to top left={xshift=10pt,yshift=-\tcboxedtitleheight/2},
  boxed title style={colback=thm-color!10,colframe=thm-color!80!black,height=16pt,valign=center,bean arc},
  separator sign=.,
  label separator={},top=8pt,bottom=2pt,left=4pt,right=4pt,boxrule=1pt
}{thm}

\newtcbtheorem{lemma}{\lemmaname}{%
  enhanced jigsaw,
  frame hidden,boxrule=0pt,
  colback=lem-color!10,colframe=lem-color!10,
  fonttitle=\sffamily\bfseries,
  attach boxed title to top left={yshift=-\tcboxedtitleheight},
  boxed title style={boxrule=0pt,boxsep=2pt,interior code={\fill[lem-color, smooth] (interior.north west)--(interior.south west)--([xshift=-2mm]interior.south east)--([xshift=2mm]interior.north east)--cycle;}},
  separator sign=.,
  label separator={},
  borderline north={1pt}{0pt}{lem-color},
  before upper={\hspace{\tcboxedtitlewidth}},
  sharp corners,top=2pt,bottom=2pt,left=4pt,right=4pt
}{lem:}

\newtcbtheorem{example}{\examplename}{%
  base theorem style,
  colback=white,colframe=white,
  borderline west={1.5pt}{0pt}{exm-color},
  left=8pt,coltitle=exm-color,boxsep=2pt,top=0pt,bottom=0pt
}{ex}

\NewTColorBox{solution}{ O{} }{%
  enhanced,colback=white,colframe=white,
  borderline east={1.5pt}{0pt}{rem-color},
  left=8pt,right=4pt,top=4pt,bottom=4pt,
  before skip=10pt,after skip=10pt,breakable,sharp corners,boxrule=0pt,frame hidden,parbox=false,
  overlay={\node[rotate=-90, anchor=south west,font=\tiny\bfseries] at ([yshift=3pt, xshift=-2pt]frame.north east) {\MakeUppercase{\solutionname}};}
}

\newtcbtheorem{remark}{\remarkname}{%
  base theorem style,colback=white,colframe=white,
  borderline west={1.5pt}{0pt}{rem-color},
  left=8pt,top=0pt,bottom=0pt,boxsep=2pt,coltitle=black
}{rem}

\newtcbtheorem[no counter]{motivation}{}{%
  base theorem style,colback=white,colframe=white,
  borderline west={1.5pt}{0pt}{mot-color},
  left=8pt,boxsep=2pt,before skip=10pt,after skip=10pt,coltitle=black
}{mot}

\newtcbtheorem{proposition}{\propositionname}{%
  enhanced jigsaw,
  colback=prop-color!10,colframe=prop-color!80!black,
  fonttitle=\bfseries,
  attach boxed title to top left={yshift=-\tcboxedtitleheight},
  boxed title style={boxrule=0pt,boxsep=2.5pt,colback=prop-color!80!black,colframe=prop-color!80!black,sharp corners=uphill},
  separator sign=.,label separator={},top=\tcboxedtitleheight,bottom=2pt,left=2pt,right=2pt,
  before skip=10pt,after skip=10pt,breakable
}{prop}

\newtcbtheorem{corollary}{\corollaryname}{%
  enhanced jigsaw,
  colback=cor-color!10,colframe=cor-color!80!black,boxrule=0pt,
  fonttitle=\sffamily\bfseries,coltitle=black,
  separator sign={},label separator={},
  description font=\normalfont\sffamily,description delimiters={(}{)},
  attach title to upper,after title={.\ },
  frame hidden,borderline west={2pt}{0pt}{cor-color},
  sharp corners,top=2pt,bottom=2pt,left=5pt,right=5pt,
  before skip=10pt,after skip=10pt,breakable
}{cor}

\newtcbtheorem{summary}{Summary}{%
  enhanced jigsaw,
  colback=ntnu-yellow!10,colframe=ntnu-yellow!80!black,
  fonttitle=\bfseries,coltitle=black,
  attach boxed title to top left={xshift=10pt,yshift=-\tcboxedtitleheight/2},
  boxed title style={colback=ntnu-yellow!10,colframe=ntnu-yellow!80!black,height=16pt,bean arc},
  separator sign=.,label separator={},sharp corners,top=6pt,bottom=2pt,left=2pt,right=2pt,
  before skip=10pt,after skip=10pt,breakable
}{sum}

% ---------- Learning goals ----------
\NewTColorBox{learninggoals}{ O{} }{%
  enhanced,
  breakable,
  colback=ntnu-lightblue!10,
  colframe=ntnu-lightblue!10,
  fonttitle=\sffamily\bfseries,
  coltitle=thm-color!,
  attach boxed title to top left={xshift=10pt,yshift=-\tcboxedtitleheight/2},
  boxed title style={colback=thm-color!90,colframe=thm-color!90,height=18pt,valign=center,rounded corners},
  separator sign=.,top=8pt,bottom=6pt,left=10pt,right=10pt,boxrule=0.8pt,
  before skip=12pt,after skip=12pt,sharp corners,
  borderline west={4pt}{0pt}{thm-color!70},
  halign title=flush center,
  fontupper=\small,
}

\renewenvironment{proof}[1][\proofname]{%
  \begin{tcolorbox}[
      blanker,
      borderline west={2pt}{0pt}{thm-color},
      before skip=10pt,
      after skip=10pt,
      left=8pt,
      breakable
    ]
    \textbf{#1}.
    }{\end{tcolorbox}}

% ---------- Graphics & TikZ ----------
\usepackage{standalone}
\usepackage{pgfplots}
\pgfplotsset{compat=newest}
\usetikzlibrary{arrows.meta, backgrounds, positioning, calc, patterns, matrix}
\tikzset{>=Latex}
\usepackage{tikz-3dplot}